---
title: "Mental Health Data Prize"
author: "Rachael Kilonzo"
date: "2025-09-04"
output:
  word_document: default
  pdf_document: default
  html_document: default
---



```{r}



#-----------------------------------------------------------------------------#
# 1.  Working Directory
#-----------------------------------------------------------------------------#

getwd() # Get the current working directory



# create a vector of the package names
libs <- c("rJava", "tidyverse", "dplyr", "readxl", "listr", "tools", "openxlsx",
          "stringr", "writexl", "psych", "lsr", "meta", "effsize", "esc")


# check if the packages are installed
installed_libs <- libs %in% rownames(
  installed.packages()
)

# install the packages that are not installed
if(any(installed_libs == FALSE)) {
  install.packages(
    libs[!installed_libs]
  )
}

# Load the packages
invisible(lapply(
  libs, 
  library,
  character.only = TRUE
)
)




```


import the combined dataset


```{r}

rm(list = ls())

mhdp <- read_excel("mhdp_data.xlsx", col_type = "text")


mhdp <- mhdp %>%
  mutate(across(c(14:117), as.numeric))



```



Description

```{r}


table(mhdp$school_county, mhdp$timepoint, useNA = "ifany")


# Dataset A

# size
length(unique(mhdp$participant_id[mhdp$dataset == "Dataset A"])) # n= 3226

# Number of schools

length(unique(mhdp$school_name[mhdp$dataset == "Dataset A"])) # n= 10

# school county and the percentage of participants from each county


school_county_datasetA <- mhdp %>%
  filter(dataset == "Dataset A") %>%
  distinct(participant_id, school_county) %>%
  count(school_county) %>%
  mutate(percentage = 100 * n / sum(n))

school_county_datasetA


# school_county                n               percentage
# Kiambu	                   1485	              46.03224    peri-urban		
# Makueni	                   957	              29.66522		rural
# Nairobi	                   784	              24.30254	  urban


# Dataset B

length(unique(mhdp$participant_id[mhdp$dataset == "Dataset B"])) # n= 1174

length(unique(mhdp$school_name[mhdp$dataset == "Dataset B"])) # n= 3

school_county_datasetB <- mhdp %>%
  filter(dataset == "Dataset B") %>%
  distinct(participant_id, school_county) %>%
  count(school_county) %>%
  mutate(percentage = 100 * n / sum(n))

school_county_datasetB


# school_county     n percentage
#   <chr>         <int>      <dbl>
# 1 Kisumu          668       56.9
# 2 Nakuru          506       43.1





# For some reason one of the schools in Kisumu had a Tau group while the rest sis not.
# Eliminating it from the study

school_county_datasetB <- mhdp %>%
  filter(dataset == "Dataset B", school_name != "OrandoKisumu") %>%
  distinct(participant_id, school_county) %>%
  count(school_county) %>%
  mutate(percentage = 100 * n / sum(n))

school_county_datasetB 

school_county_datasetB 

# school_county     n percentage
#  <chr>         <int>      <dbl>
# 1 Kisumu          251       33.2
# 2 Nakuru          506       66.8




# Dataset C




# Dataset C

length(unique(mhdp$participant_id[mhdp$dataset == "Dataset C"])) # n= 1715

length(unique(mhdp$school_name[mhdp$dataset == "Dataset C"])) # n= 6


school_county_datasetC <- mhdp %>%
  filter(dataset == "Dataset C") %>%
  distinct(participant_id, school_county) %>%
  count(school_county) %>%
  mutate(percentage = 100 * n / sum(n))

school_county_datasetC

# school_county     n percentage
#   <chr>         <int>      <dbl>
#  Kiambu          486       28.3             # peri-urban
#  Nairobi        1229       71.7             # urban 



```



Calculate Scale Totals

```{r}


mhdp <- mhdp %>%
  mutate(
    phq_total = if_else(
      if_any(phq_1:phq_8, is.na),
      NA_real_,
      rowSums(across(phq_1:phq_8))
    ),
    gad_total = if_else(
      if_any(gad_1:gad_7, is.na),
      NA_real_,
      rowSums(across(gad_1:gad_7))
    ),
    swemwbs_total = if_else(
      if_any(swemwbs_1:swemwbs_7, is.na),
      NA_real_,
      rowSums(across(swemwbs_1:swemwbs_7))
    )
  ) %>%
  relocate(phq_total, .after = phq_8) %>%
  relocate(gad_total, .after = gad_7) %>%
  relocate(swemwbs_total, .after = swemwbs_7)











mhdp <- mhdp %>%
  mutate(
    Depression_Level = case_when(
      phq_total <= 4 ~ "Minimal depression",
      between(phq_total, 5, 9) ~ "Mild depression",
      between(phq_total, 10, 14) ~ "Moderate depression",
      phq_total >= 15 ~ "Severe depression",
      TRUE ~ NA_character_
    ),
    Anxiety_Level = case_when(
      gad_total <= 4 ~ "Minimal anxiety",
      between(gad_total, 5, 9) ~ "Mild anxiety",
      between(gad_total, 10, 14) ~ "Moderate anxiety",
      gad_total >= 15 ~ "Severe anxiety",
      TRUE ~ NA_character_
    )
  ) %>%
  relocate(Depression_Level, .after = phq_total) %>%
  relocate(Anxiety_Level, .after = gad_total)
  

mhdp <- mhdp %>%
  mutate(
    Clinical_Dep_Sample= case_when(
      phq_total <= 9 ~ "No",
      phq_total >= 10 ~ "Yes",
      TRUE ~ NA_character_
    ),
    Clinical_Anx_Sample = case_when(
      gad_total <= 9 ~ "No",
      gad_total>= 10 ~ "Yes",
      TRUE ~ NA_character_
    )
  ) %>%
  relocate(Clinical_Dep_Sample,.after = Depression_Level) %>%
  relocate(Clinical_Anx_Sample,.after = Anxiety_Level)



```



Prevalence Rates

```{r}


mhdp_baseline <- mhdp %>%
  filter(timepoint == 0)

# Baseline Depression Prevalence

table(mhdp_baseline$Clinical_Dep_Sample)

baseline_depression_prevalence <- mhdp_baseline %>%
  summarise(
    n = n(),
    clinical_cases = sum(Clinical_Dep_Sample == "Yes", na.rm = TRUE),
    prevalence_rate = (clinical_cases / n) * 100
  )

baseline_depression_prevalence # 22.6%


baseline_depression_by_dataset <- mhdp_baseline %>%
  group_by(dataset) %>%                          # Group by the 'dataset' column
  summarise(
    n = n(),                                     # Total participants in this group
    clinical_cases = sum(Clinical_Dep_Sample == "Yes", na.rm = TRUE),  # Count of clinical cases
    prevalence_rate = (clinical_cases / n) * 100 # Prevalence percentage
  )

baseline_depression_by_dataset


# Baseline Anxiety Prevalence

table(mhdp_baseline$Clinical_Anx_Sample)

baseline_anxiety_prevalence <- mhdp_baseline %>%
  summarise(
    n = n(),
    clinical_cases = sum(Clinical_Anx_Sample == "Yes", na.rm = TRUE),
    prevalence_rate = (clinical_cases / n) * 100
  )



baseline_anxiety_prevalence  # 20.9%

baseline_anxiety_by_dataset <- mhdp_baseline %>%
  group_by(dataset) %>%                          # Group by the 'dataset' column
  summarise(
    n = n(),                                     # Total participants in this group
    clinical_cases = sum(Clinical_Anx_Sample == "Yes", na.rm = TRUE),  # Count of clinical cases
    prevalence_rate = (clinical_cases / n) * 100 # Prevalence percentage
  )


# Either Depression or Anxiety


# Combine depression and anxiety prevalence by dataset
baseline_combined <- baseline_depression_by_dataset %>%
  select(dataset, depression = prevalence_rate) %>%
  left_join(
    baseline_anxiety_by_dataset %>% select(dataset, anxiety = prevalence_rate),
    by = "dataset"
  ) %>%
  pivot_longer(cols = c(depression, anxiety),
               names_to = "condition",
               values_to = "prevalence_rate")

# Plot
ggplot(baseline_combined, aes(x = dataset, y = prevalence_rate, fill = condition)) +
  geom_bar(stat = "identity", position = "dodge") +  # dodge puts bars side by side
  geom_text(aes(label = round(prevalence_rate, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5) +
  scale_fill_manual(values = c("depression" = "steelblue", "anxiety" = "tomato")) +
  labs(
    title = "Baseline Depression and Anxiety Prevalence by Dataset",
    x = "Dataset",
    y = "Prevalence Rate (%)",
    fill = "Condition"
  ) +
  theme_minimal()

ggsave("baseline_prevalence_by_dataset.png", width = 8, height = 6, dpi = 300)



```




```{r}

# Prepare gender data
gender_data <- data.frame(
  gender = c("Male", "Female", "Not Answered"),
  count = c(3436, 2368, 311)
)

# Bar chart
ggplot(gender_data, aes(x = gender, y = count, fill = gender)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5) +
  scale_fill_manual(values = c("Male" = "steelblue", "Female" = "tomato", "Not Answered" = "grey")) +
  labs(title = "Gender Distribution of Participants", x = "Gender", y = "Number of Participants") +
  theme_minimal()

ggsave("gender_distribution_bar.png", width = 8, height = 6, dpi = 300)



```







```{r}




mhdp_end <- mhdp %>%
  filter(timepoint == 4)

# Baseline Depression Prevalence

table(mhdp_end$Clinical_Dep_Sample)

end_depression_prevalence <- mhdp_end %>%
  summarise(
    n = n(),
    clinical_cases = sum(Clinical_Dep_Sample == "Yes", na.rm = TRUE),
    prevalence_rate = (clinical_cases / n) * 100
  )

end_depression_prevalence # 22.6%


end_depression_by_dataset <- mhdp_end %>%
  group_by(dataset) %>%                          # Group by the 'dataset' column
  summarise(
    n = n(),                                     # Total participants in this group
    clinical_cases = sum(Clinical_Dep_Sample == "Yes", na.rm = TRUE),  # Count of clinical cases
    prevalence_rate = (clinical_cases / n) * 100 # Prevalence percentage
  )

end_depression_by_dataset


# Baseline Anxiety Prevalence

table(mhdp_end$Clinical_Anx_Sample)

end_anxiety_prevalence <- mhdp_end %>%
  summarise(
    n = n(),
    clinical_cases = sum(Clinical_Anx_Sample == "Yes", na.rm = TRUE),
    prevalence_rate = (clinical_cases / n) * 100
  )



end_anxiety_prevalence  # 20.9%

end_anxiety_by_dataset <- mhdp_end %>%
  group_by(dataset) %>%                          # Group by the 'dataset' column
  summarise(
    n = n(),                                     # Total participants in this group
    clinical_cases = sum(Clinical_Anx_Sample == "Yes", na.rm = TRUE),  # Count of clinical cases
    prevalence_rate = (clinical_cases / n) * 100 # Prevalence percentage
  )


# Either Depression or Anxiety


# Combine depression and anxiety prevalence by dataset
end_combined <- end_depression_by_dataset %>%
  select(dataset, depression = prevalence_rate) %>%
  left_join(
    end_anxiety_by_dataset %>% select(dataset, anxiety = prevalence_rate),
    by = "dataset"
  ) %>%
  pivot_longer(cols = c(depression, anxiety),
               names_to = "condition",
               values_to = "prevalence_rate")

# Plot
ggplot(end_combined, aes(x = dataset, y = prevalence_rate, fill = condition)) +
  geom_bar(stat = "identity", position = "dodge") +  # dodge puts bars side by side
  geom_text(aes(label = round(prevalence_rate, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5) +
  scale_fill_manual(values = c("depression" = "steelblue", "anxiety" = "tomato")) +
  labs(
    title = "Endpoint Depression and Anxiety Prevalence by Dataset",
    x = "Dataset",
    y = "Prevalence Rate (%)",
    fill = "Condition"
  ) +
  theme_minimal()

ggsave("end_prevalence_by_dataset.png", width = 8, height = 6, dpi = 300)




```







```{r}

# Keep only baseline (0) and endline (4)
df <- mhdp %>%
  filter(timepoint %in% c(0, 4)) %>%
  mutate(
    time_label = ifelse(timepoint == 0, "Baseline", "Endline")
  )

# ---- Depression prevalence by condition × time ----
dep_summary <- df %>%
  group_by(condition, time_label) %>%
  summarise(
    n = n(),
    clinical_cases = sum(Clinical_Dep_Sample == "Yes", na.rm = TRUE),
    prevalence = (clinical_cases / n) * 100,
    .groups = "drop"
  ) %>%
  mutate(measure = "Depression")

# ---- Anxiety prevalence by condition × time ----
anx_summary <- df %>%
  group_by(condition, time_label) %>%
  summarise(
    n = n(),
    clinical_cases = sum(Clinical_Anx_Sample == "Yes", na.rm = TRUE),
    prevalence = (clinical_cases / n) * 100,
    .groups = "drop"
  ) %>%
  mutate(measure = "Anxiety")

# ---- Combine both ----
combined <- bind_rows(dep_summary, anx_summary)

# ---- Plot: Baseline vs Endline for Control vs Shamiri ----
ggplot(combined,
       aes(x = time_label, y = prevalence,
           fill = condition)) +
  geom_bar(stat = "identity",
           position = "dodge") +
  geom_text(aes(label = round(prevalence, 1)),
            position = position_dodge(width = 0.9),
            vjust = -0.5) +
  facet_wrap(~ measure) +
  labs(
    title = "Baseline vs Endline Prevalence\nShamiri vs Control",
    x = "Timepoint",
    y = "Prevalence (%)",
    fill = "Condition"
  ) +
  theme_minimal()

ggsave("baseline_endline_comparison.png", width = 8, height = 6, dpi = 300)




```





```{r}


summary_df <- mhdp %>%
  group_by(dataset, condition, timepoint) %>%
  summarise(
    n       = sum(!is.na(phq_total)),
    mean_phq = mean(phq_total, na.rm = TRUE),
    sd_phq   = sd(phq_total, na.rm = TRUE),
    se_phq   = sd_phq / sqrt(n),
    ci95_phq_low  = mean_phq - 1.96 * (sd_phq / sqrt(n)),
    ci95_phq_high = mean_phq + 1.96 * (sd_phq / sqrt(n)),

    mean_gad = mean(gad_total, na.rm = TRUE),
    sd_gad   = sd(gad_total, na.rm = TRUE),
    se_gad   = sd_gad / sqrt(n),
    ci95_gad_low  = mean_gad - 1.96 * (sd_gad / sqrt(n)),
    ci95_gad_high = mean_gad + 1.96 * (sd_gad / sqrt(n)),

    mean_swe = mean(swemwbs_total, na.rm = TRUE),
    sd_swe   = sd(swemwbs_total, na.rm = TRUE),
    se_swe   = sd_swe / sqrt(n),
    ci95_swe_low  = mean_swe - 1.96 * (sd_swe / sqrt(n)),
    ci95_swe_high = mean_swe + 1.96 * (sd_swe / sqrt(n))
  ) %>%
  ungroup() %>%
  arrange(dataset, condition, timepoint)


write_xlsx(summary_df, "phq_gad_swemwbs.xlsx")

```



```{r}


p_phq <- ggplot(summary_df, aes(x = as.numeric(timepoint), y = mean_phq,
                                color = condition, group = condition)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci95_phq_low, ymax = ci95_phq_high), width = 0.3) +
  facet_wrap(~ dataset, scales = "free_x") +
  labs(
    title = "PHQ Scores Across Timepoints",
    x = "Timepoint (weeks)",
    y = "Mean PHQ Score"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave("phq_scores.png", p_phq, width = 8, height = 6, dpi = 300)





p_gad <- ggplot(summary_df, aes(x = as.numeric(timepoint), y = mean_gad,
                                color = condition, group = condition)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci95_gad_low, ymax = ci95_gad_high), width = 0.3) +
  facet_wrap(~ dataset, scales = "free_x") +
  labs(
    title = "GAD Scores Across Timepoints",
    x = "Timepoint (weeks)",
    y = "Mean GAD Score"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave("gad_scores.png", p_gad, width = 8, height = 6, dpi = 300)




p_swe <- ggplot(summary_df, aes(x = as.numeric(timepoint), y = mean_swe,
                                color = condition, group = condition)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci95_swe_low, ymax = ci95_swe_high), width = 0.3) +
  facet_wrap(~ dataset, scales = "free_x") +
  labs(
    title = "SWEMWBS Scores Across Timepoints",
    x = "Timepoint (weeks)",
    y = "Mean SWEMWBS Score"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave("swemwbs_scores.png", p_swe, width = 8, height = 6, dpi = 300)




```



effect sizes for phq

```{r}

# Dataset A - Templeton_2

datasetA <- mhdp %>%
  filter(dataset == "Dataset A",
         timepoint %in% c(0,2,4,8)) %>%   
  select(participant_id, timepoint, phq_total,condition,school_name) %>%
  tidyr::pivot_wider(names_from = timepoint, values_from = phq_total,
                     names_prefix = "week_")

table(datasetA$condition)
table(datasetA$school_name)

cohensD(datasetA$week_4, datasetA$week_0, method = "paired") # d = 0.2341103
cohensD(datasetA$week_8, datasetA$week_4, method = "paired") # d = 0.0770626
cohensD(datasetA$week_8, datasetA$week_0, method = "paired") # d = 0.1769474




# dataset A participants improved modestly between baseline and week 4, gains held steady through week 8, but little extra change after the first month.




# Dataset B - Wellspring

datasetB <- mhdp %>%
  filter(dataset == "Dataset B",
         timepoint %in% c(0,2,4,8)) %>%   
  select(participant_id, timepoint, phq_total,condition, school_name) %>%
  tidyr::pivot_wider(names_from = timepoint, values_from = phq_total,
                     names_prefix = "week_")

table(datasetB$condition)
table(datasetB$school_name)


# Within group comparisons

# Combine single-condition schools
single_schools <- datasetB %>%
  filter(school_name %in% c("ElbargonNakuru", "RidoreKisumu") ) 

table(single_schools$condition)
table(single_schools$school_name)

# Compute paired Cohen's d for combined schools
cohensD(single_schools$week_4, single_schools$week_0, method = "paired") # 0.2085989
cohensD(single_schools$week_8, single_schools$week_4, method = "paired") # 0.1882511
cohensD(single_schools$week_8, single_schools$week_0, method = "paired") # 0.227074



# Subset the school with 2 conditions (e.g., OrandoKisumu)
orando <- datasetB %>%
  filter(school_name == "OrandoKisumu") 

table(orando$condition)
table(orando$school_name)



# Between-group Cohen's d at each timepoint

cohensD(week_0 ~ condition, data = orando, method = "pooled") # 0.3928144
cohensD(week_2 ~ condition, data = orando, method = "pooled") # 0.09961096
cohensD(week_4 ~ condition, data = orando, method = "pooled") # 0.3721237
cohensD(week_8 ~ condition, data = orando, method = "pooled") # 0.325493



##########################  ALTERNATIVELY ###########################################

# Define the data we need to calculate SMD/d
# This is just some example data that we made up

grp1m  <- mhdp %>%
  filter(school_name == "OrandoKisumu", condition == "TAU", timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE))     # mean of tau group at orando


grp2m  <-  mhdp %>%
  filter(school_name == "OrandoKisumu", condition == "Shamiri",  timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE))     # mean of shamiri group at orando


grp1sd <-   mhdp %>%
  filter(school_name == "OrandoKisumu", condition == "TAU",  timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE))         # sd of tau group at orando

grp2sd <-  mhdp %>%
  filter(school_name == "OrandoKisumu", condition == "Shamiri",  timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE))     # sd of shamiri group at orando

grp1n <- mhdp %>%
  filter(school_name == "OrandoKisumu", condition == "TAU",  timepoint == 4) %>%
  summarise(n = sum(!is.na(phq_total)))
  # n of tau group at orando

grp2n <- mhdp %>%
  filter(school_name == "OrandoKisumu", condition == "Shamiri",  timepoint == 0) %>%
  summarise(n = sum(!is.na(phq_total)))
   # n of shamiri group at orando



# Calculate effect size
esc_mean_sd(grp1m = grp1m,
            grp2m = grp2m, 
            grp1sd = grp1sd,
            grp2sd = grp2sd, 
            grp1n = grp1n,
            grp2n = grp2n)


# RESULTS

# Effect Size Calculation for Meta Analysis

#      Conversion: mean and sd to effect size d
#     Effect Size:   0.3792
#  Standard Error:   0.1186
#        Variance:   0.0141
#        Lower CI:   0.1468
#        Upper CI:   0.6115
#          Weight:  71.1454

# SIMILAR

########### END ALTERNATIVE CHUNK #################################################


# Pivot to wide format for paired comparisons

# For intervention group
intervention <- orando %>% filter(condition == "Shamiri")


cohensD(intervention$week_4, intervention$week_0, method = "paired")  # 0.2222388
cohensD(intervention$week_8, intervention$week_4, method = "paired")  # 0.05197212
cohensD(intervention$week_8, intervention$week_0, method = "paired")  # 0.1346733


# For control group
control <- orando %>% filter(condition == "TAU")


cohensD(control$week_4, control$week_0, method = "paired")  # 0.07441635
cohensD(control$week_8, control$week_4, method = "paired")  # 0.01745369
cohensD(control$week_8, control$week_0, method = "paired")  # 0.08173058



# Dataset C - Anansi_1

# Subset Dataset C (all schools with 2 conditions)

datasetC <- mhdp %>%
  filter(dataset == "Dataset C",
         timepoint %in% c(0,2,4,8,40,56)) %>%   
  select(participant_id, timepoint, phq_total,condition,school_name) %>%
  tidyr::pivot_wider(names_from = timepoint, values_from = phq_total,
                     names_prefix = "week_")

table(datasetC$condition)
table(datasetC$school_name)


# Between-group Cohen's d at each timepoint

cohensD(week_0 ~ condition, data = datasetC, method = "pooled")  # 0.0159323
cohensD(week_2 ~ condition, data = datasetC, method = "pooled")  # 0.02472405
cohensD(week_4 ~ condition, data = datasetC, method = "pooled")  # 0.09584029
cohensD(week_8 ~ condition, data = datasetC, method = "pooled")  # 0.05526256
cohensD(week_40 ~ condition, data = datasetC, method = "pooled") # 0.06663306
cohensD(week_56 ~ condition, data = datasetC, method = "pooled") # 0.04518765






###########################  ALTERNATIVELY ###########################################

# Define the data we need to calculate SMD/d
# This is just some example data that we made up

grp1m  <- mhdp %>%
  filter(dataset == "Dataset C", condition == "TAU", timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE))     # mean of tau group 


grp2m  <-  mhdp %>%
  filter(dataset == "Dataset C", condition == "Shamiri",  timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE))     # mean of shamiri group 


grp1sd <-   mhdp %>%
  filter(dataset == "Dataset C", condition == "TAU",  timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE))         # sd of tau group 

grp2sd <-  mhdp %>%
  filter(dataset == "Dataset C", condition == "Shamiri",  timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE))     # sd of shamiri group 

grp1n <- mhdp %>%
  filter(dataset == "Dataset C", condition == "TAU",  timepoint == 4) %>%
  summarise(n = sum(!is.na(phq_total)))
  # n of tau group

grp2n <- mhdp %>%
  filter(dataset == "Dataset C", condition == "Shamiri",  timepoint == 0) %>%
  summarise(n = sum(!is.na(phq_total)))
   # n of shamiri group



# Calculate effect size
esc_mean_sd(grp1m = grp1m,
            grp2m = grp2m, 
            grp1sd = grp1sd,
            grp2sd = grp2sd, 
            grp1n = grp1n,
            grp2n = grp2n)


# RESULTS

# Effect Size Calculation for Meta Analysis

#      Conversion: mean and sd to effect size d
#     Effect Size:   0.3792
#  Standard Error:   0.1186
#        Variance:   0.0141
#        Lower CI:   0.1468
#        Upper CI:   0.6115
#          Weight:  71.1454

# ALMOST SIMILAR

########### END ALTERNATIVE CHUNK #################################################






# within-group paired Cohen's d 

# Intervention group
intervention <- datasetC %>% filter(condition == "Shamiri")  


cohensD(intervention$week_4,  intervention$week_0, method = "paired")   # 0.3181884
cohensD(intervention$week_8,  intervention$week_0, method = "paired")   # 0.3181884
cohensD(intervention$week_40, intervention$week_0, method = "paired")   # 0.291483
cohensD(intervention$week_56, intervention$week_0, method = "paired")   # 0.1593998

cohensD(intervention$week_8,  intervention$week_4, method = "paired")   # 0.04900636
cohensD(intervention$week_40, intervention$week_8, method = "paired")   # 0.01712202
cohensD(intervention$week_56, intervention$week_40, method = "paired")  # 0.09335289


# Control group
control <- datasetC %>% filter(condition == "TAU")  


cohensD(control$week_4,  control$week_0, method = "paired")   # 0.195896
cohensD(control$week_8,  control$week_0, method = "paired")   # 0.1768834
cohensD(control$week_40, control$week_0, method = "paired")   # 0.2645333
cohensD(control$week_56, control$week_0, method = "paired")   # 0.1628986

cohensD(control$week_8,  control$week_4, method = "paired")   # 0.01483827
cohensD(control$week_40, control$week_8, method = "paired")   # 0.1555986
cohensD(control$week_56, control$week_40, method = "paired")  # 0.2132756


```


effect sizes for gad

```{r}


# -------------------------------
# Dataset A - Templeton_2 (GAD)
# -------------------------------



# Dataset A - Templeton_2

datasetA <- mhdp %>%
  filter(dataset == "Dataset A",
         timepoint %in% c(0,2,4,8)) %>%   
  select(participant_id, timepoint, gad_total,condition,school_name) %>%
  tidyr::pivot_wider(names_from = timepoint, values_from = gad_total,
                     names_prefix = "week_")

table(datasetA$condition)
table(datasetA$school_name)

cohensD(datasetA$week_4, datasetA$week_0, method = "paired") # d = 0.2264271
cohensD(datasetA$week_8, datasetA$week_4, method = "paired") # d = 0.03048502
cohensD(datasetA$week_8, datasetA$week_0, method = "paired") # d = 0.191034




# dataset A participants improved modestly between baseline and week 4, gains held steady through week 8, but little extra change after the first month.




# Dataset B - Wellspring

datasetB <- mhdp %>%
  filter(dataset == "Dataset B",
         timepoint %in% c(0,2,4,8)) %>%   
  select(participant_id, timepoint, gad_total,condition, school_name) %>%
  tidyr::pivot_wider(names_from = timepoint, values_from = gad_total,
                     names_prefix = "week_")

table(datasetB$condition)
table(datasetB$school_name)


# Combine single-condition schools
single_schools <- datasetB %>%
  filter(school_name %in% c("ElbargonNakuru", "RidoreKisumu") ) 

table(single_schools$condition)
table(single_schools$school_name)

# Compute paired Cohen's d for combined schools
cohensD(single_schools$week_4, single_schools$week_0, method = "paired") # d = 0.3422325
cohensD(single_schools$week_8, single_schools$week_4, method = "paired") # d = 0.005566758
cohensD(single_schools$week_8, single_schools$week_0, method = "paired") # d = 0.2827775



# Subset the school with 2 conditions (e.g., OrandoKisumu)
orando <- datasetB %>%
  filter(school_name == "OrandoKisumu") 

table(orando$condition)
table(orando$school_name)



# Between-group Cohen's d at each timepoint

cohensD(week_0 ~ condition, data = orando, method = "pooled") # d = 0.2680935
cohensD(week_2 ~ condition, data = orando, method = "pooled") # d = 0.3476158
cohensD(week_4 ~ condition, data = orando, method = "pooled") # d = 0.3216598
cohensD(week_8 ~ condition, data = orando, method = "pooled") # d = 0.1421356





# Pivot to wide format for paired comparisons

# For intervention group
intervention <- orando %>% filter(condition == "Shamiri")


cohensD(intervention$week_4, intervention$week_0, method = "paired")  # d = 0.1395569
cohensD(intervention$week_8, intervention$week_4, method = "paired")  # d = 0.03786314
cohensD(intervention$week_8, intervention$week_0, method = "paired")  # d = 0.122623


# For control group
control <- orando %>% filter(condition == "TAU")


cohensD(control$week_4, control$week_0, method = "paired")  # d = 0.09638222
cohensD(control$week_8, control$week_4, method = "paired")  # d = 0.1349584
cohensD(control$week_8, control$week_0, method = "paired")  # d = 0.1790978



# Dataset C - Anansi_1

# Subset Dataset C (all schools with 2 conditions)

datasetC <- mhdp %>%
  filter(dataset == "Dataset C",
         timepoint %in% c(0,2,4,8,40,56)) %>%   
  select(participant_id, timepoint, gad_total,condition,school_name) %>%
  tidyr::pivot_wider(names_from = timepoint, values_from = gad_total,
                     names_prefix = "week_")

table(datasetC$condition)
table(datasetC$school_name)


# Between-group Cohen's d at each timepoint

cohensD(week_0 ~ condition,  data = datasetC, method = "pooled")  # d = 0.106533
cohensD(week_2 ~ condition,  data = datasetC, method = "pooled")  # d = 0.02839165
cohensD(week_4 ~ condition,  data = datasetC, method = "pooled")  # d = 0.1557447
cohensD(week_8 ~ condition,  data = datasetC, method = "pooled")  # d = 0.1172458 
cohensD(week_40 ~ condition, data = datasetC, method = "pooled")  # d = 0.0576902
cohensD(week_56 ~ condition, data = datasetC, method = "pooled")  # d = 0.004950921



# within-group paired Cohen's d 

# Intervention group
intervention <- datasetC %>% filter(condition == "Shamiri")  

cohensD(intervention$week_4,  intervention$week_0,  method = "paired")   # d = 0.2909229
cohensD(intervention$week_8,  intervention$week_0,  method = "paired")   # d = 0.2141768
cohensD(intervention$week_40, intervention$week_0,  method = "paired")   # d = 0.1246824
cohensD(intervention$week_56, intervention$week_0,  method = "paired")   # d = 0.09060511

cohensD(intervention$week_8,  intervention$week_4,  method = "paired")   # d = 0.04144486
cohensD(intervention$week_40, intervention$week_8,  method = "paired")   # d = 0.07016832
cohensD(intervention$week_56, intervention$week_40, method = "paired")   # d = 0.0279386


# Control group
control <- datasetC %>% filter(condition == "TAU")  


cohensD(control$week_4,  control$week_0,  method = "paired")   # d = 0.1831012
cohensD(control$week_8,  control$week_0,  method = "paired")   # d = 0.1679012
cohensD(control$week_40, control$week_0,  method = "paired")   # d = 0.115468
cohensD(control$week_56, control$week_0,  method = "paired")   # d = 0.1509054

cohensD(control$week_8,  control$week_4,  method = "paired")   # d = 0.02924927
cohensD(control$week_40, control$week_8,  method = "paired")   # d = 0.02130046
cohensD(control$week_56, control$week_40, method = "paired")   # d = 0.07879461



```




Some Meta-Analysis


```{r}


# - Meta-analysis of the datasets (A, B, C)
# - Separate analyses for within-group (pre–post) vs between-group
# - will be using effsize::cohen.d and lsr::cohensD
# - manually compute SE and variance for meta-analysis





# For pooled effect sizes (between-group, dataset B and specifically OrandoKisumu school and dataset C) the only aspects with intervention and control groups


datasetB_two_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name == "OrandoKisumu") 

datasetC_all_schools <- mhdp %>%
  filter(dataset == "Dataset C")


# TAU N
grp1n_db_tc_t <- datasetB_two_conditions %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(n = sum(!is.na(phq_total))) %>%
  pull(n)

# grp1n_db_tc_t = 115


grp1n_dc_t <- datasetC_all_schools %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(n = sum(!is.na(phq_total))) %>%
  pull(n)

# grp1n_dc_t = 686



# Shamiri N
grp1n_db_tc_s <- datasetB_two_conditions %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(n = sum(!is.na(phq_total))) %>%
  pull(n)

# grp1n_db_tc_s = 134


grp1n_dc_s <- datasetC_all_schools %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(n = sum(!is.na(phq_total))) %>%
  pull(n)

# grp1n_dc_s = 515




# TAU mean - Dataset B (two-condition schools)
grp1m_db_tc_t <- datasetB_two_conditions %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE)) %>%
  pull(mean_phq)



# TAU mean - Dataset C (all schools)
grp1m_dc_t <- datasetC_all_schools %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE)) %>%
  pull(mean_phq)



# Shamiri mean - Dataset B (two-condition schools)
grp1m_db_tc_s <- datasetB_two_conditions %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE)) %>%
  pull(mean_phq)

# Shamiri mean - Dataset C (all schools)
grp1m_dc_s <- datasetC_all_schools %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(mean_phq = mean(phq_total, na.rm = TRUE)) %>%
  pull(mean_phq)
 

# TAU SD - Dataset B (two-condition schools)
grp1sd_db_tc_t <- datasetB_two_conditions %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE)) %>%
  pull(sd_phq)

# TAU SD - Dataset C (all schools)
grp1sd_dc_t <- datasetC_all_schools %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE)) %>%
  pull(sd_phq)


# Shamiri SD - Dataset B (two-condition schools)
grp1sd_db_tc_s <- datasetB_two_conditions %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE)) %>%
  pull(sd_phq)

# Shamiri SD - Dataset C (all schools)
grp1sd_dc_s <- datasetC_all_schools %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(sd_phq = sd(phq_total, na.rm = TRUE)) %>%
  pull(sd_phq)





meta_input <- data.frame(
  study = c( "Dataset B with Both Conditions", "Dataset C"),
  n.e = c(grp1n_db_tc_s, grp1n_dc_s),
  mean.e = c(grp1m_db_tc_s, grp1m_dc_s),
  sd.e = c(grp1sd_db_tc_s, grp1sd_dc_s),
  n.c = c(grp1n_db_tc_t, grp1n_dc_t),
  mean.c = c(grp1m_db_tc_t, grp1m_dc_t),
  sd.c = c(grp1sd_db_tc_t, grp1sd_dc_t)
)



meta_d <- metacont(
  n.e = n.e, mean.e = mean.e, sd.e = sd.e,
  n.c = n.c, mean.c = mean.c, sd.c = sd.c,
  studlab = study,
  data = meta_input,
  sm = "SMD",
  method.smd = "Hedges",
  random = TRUE,
  method.tau = "REML",
  method.random.ci = "HK"
)


meta_d


```






Within group


```{r}


datasetB_one_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name != "OrandoKisumu")

datasetA_all_schools <- mhdp %>%
  filter(dataset == "Dataset A")


# Compute within-group effect sizes
# We'll calculate mean and SD of change scores (post - pre)

compute_within <- function(data, label) {
  wide <- data %>%
    filter(timepoint %in% c(0, 4)) %>%
    select(participant_id, condition, timepoint, phq_total) %>%
    tidyr::pivot_wider(
      names_from = timepoint,
      values_from = phq_total,
      names_prefix = "week_"
    ) %>%
    mutate(change = week_4 - week_0)

  summary_tbl <- wide %>%
    group_by(condition) %>%
    summarise(
      n = sum(!is.na(change)),
      mean_change = mean(change, na.rm = TRUE),
      sd_change = sd(change, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)
  
  return(summary_tbl)
}

# Compute for Dataset B (without OrandoKisumu) and Dataset A
within_B <- compute_within(datasetB_one_conditions, "Dataset B - without OrandoKisumu")
within_A <- compute_within(datasetA_all_schools, "Dataset A - All Schools")

# Combine all
within_input <- bind_rows(within_B, within_A)


# Compute within-group effect size (Cohen's dz / Hedges’ g equivalent) 
within_meta <- within_input %>%
  mutate(
    cohen_d = mean_change / sd_change,
    J = 1 - (3 / (4 * n - 9)),           # Hedges’ correction since the sample sizes are unequal
    hedges_g = cohen_d * J,
    se_g = sqrt((1 / n) + (hedges_g^2 / (2 * n)))  # Approx. SE for within-subject d
  )


# Random-effects meta-analysis
meta_within <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", condition),
  data = within_meta,
  sm = "SMD",
  method.tau = "REML",
  hakn = TRUE,
  common = FALSE,
  random = TRUE,
  title = "Within-Group (Pre–Post) PHQ Change"
)

# Results and Forest Plot
summary(meta_within)
forest(meta_within)



```

SUBGROUP ANALYSES

 
 ON GENDER

```{r}

# --- Within-group meta-analysis by gender ---

# Step 1. Filter datasets
datasetB_one_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name != "OrandoKisumu")

datasetA_all_schools <- mhdp %>%
  filter(dataset == "Dataset A")

# Step 2. Function to compute within-group change by gender
compute_within_gender <- function(data, label) {
  wide <- data %>%
    filter(timepoint %in% c(0, 4)) %>%
    select(participant_id, condition, gender, timepoint, phq_total) %>%
    tidyr::pivot_wider(
      names_from = timepoint,
      values_from = phq_total,
      names_prefix = "week_"
    ) %>%
    mutate(change = week_4 - week_0)

  summary_tbl <- wide %>%
    group_by(condition, gender) %>%
    summarise(
      n = sum(!is.na(change)),
      mean_change = mean(change, na.rm = TRUE),
      sd_change = sd(change, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)

  return(summary_tbl)
}

# Step 3. Apply function to datasets
within_B_gender <- compute_within_gender(datasetB_one_conditions, "Dataset B - without OrandoKisumu")
within_A_gender <- compute_within_gender(datasetA_all_schools, "Dataset A - All Schools")

# Combine results
within_input_gender <- bind_rows(within_B_gender, within_A_gender)

# Step 4. Compute effect sizes (Hedges' g and SE)
within_meta_gender <- within_input_gender %>%
  mutate(
    cohen_d = mean_change / sd_change,
    J = 1 - (3 / (4 * n - 9)),                     # Hedges’ correction
    hedges_g = cohen_d * J,
    se_g = sqrt((1 / n) + (hedges_g^2 / (2 * n)))  # Approximate SE
  )


# Remove missing genders first
within_meta_gender <- within_meta_gender %>%
  filter(!is.na(gender))

# Run meta-analysis with gender as subgroup (updated for new meta version)
meta_within_gender <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", condition, "-", gender),
  data = within_meta_gender,
  sm = "SMD",
  method.tau = "REML",
  method.random.ci = "HK",         # replaces hakn
  common = FALSE,
  random = TRUE,
  subgroup = gender,               # updated name
  print.subgroup.name = TRUE,      # updated name
  title = "Within-Group (Pre–Post) PHQ Change by Gender"
)

# Output results and forest plot
summary(meta_within_gender)
forest(meta_within_gender, layout = "RevMan5", print.subgroup.name = TRUE)






```


subgroup analyses gender, between group

```{r}


# BETWEEN-GROUP META-ANALYSIS BY GENDER

# Filter datasets
datasetB_two_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name == "OrandoKisumu")

datasetC_all_schools <- mhdp %>%
  filter(dataset == "Dataset C")


# Function to compute summary stats by condition and gender
get_summary_gender <- function(data, label) {
  data %>%
    filter(timepoint == 4) %>%
    group_by(condition, gender) %>%
    summarise(
      n = sum(!is.na(phq_total)),
      mean_phq = mean(phq_total, na.rm = TRUE),
      sd_phq = sd(phq_total, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)
}

# Compute summaries by gender for each dataset
sum_B_gender <- get_summary_gender(datasetB_two_conditions, "Dataset B - OrandoKisumu")
sum_C_gender <- get_summary_gender(datasetC_all_schools, "Dataset C")

# Combine results
sum_gender <- bind_rows(sum_B_gender, sum_C_gender)

# Prepare dataset in wide format (TAU vs Shamiri per gender)
meta_input_gender <- sum_gender %>%
  tidyr::pivot_wider(
    names_from = condition,
    values_from = c(n, mean_phq, sd_phq),
    names_sep = "."
  ) %>%
  rename(
    n.e = n.Shamiri,
    mean.e = mean_phq.Shamiri,
    sd.e = sd_phq.Shamiri,
    n.c = n.TAU,
    mean.c = mean_phq.TAU,
    sd.c = sd_phq.TAU
  ) %>%
  mutate(
    # Pooled SD
    sd_pooled = sqrt(((n.e - 1) * sd.e^2 + (n.c - 1) * sd.c^2) / (n.e + n.c - 2)),
    
    # Cohen’s d
    cohen_d = (mean.e - mean.c) / sd_pooled,
    
    # Hedges’ correction
    J = 1 - (3 / (4 * (n.e + n.c) - 9)),
    
    # Hedges’ g
    hedges_g = cohen_d * J,
    
    # Standard error for Hedges’ g
    se_g = sqrt((n.e + n.c) / (n.e * n.c) + (hedges_g^2 / (2 * (n.e + n.c - 2))))
  ) %>%
  filter(!is.na(gender))  # remove missing genders if any


# --- META-ANALYSIS with gender as subgroup ---
meta_gender_between <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", gender),
  data = meta_input_gender,
  sm = "SMD",
  method.tau = "REML",
  method.random.ci = "HK",
  common = FALSE,
  random = TRUE,
  subgroup = gender,                 # subgroup analysis
  print.subgroup.name = TRUE,
  title = "Between-Group (Shamiri vs TAU) PHQ Effect Sizes by Gender"
)

# --- Output results ---
summary(meta_gender_between)

# Forest plot
forest(meta_gender_between, layout = "RevMan5", print.subgroup.name = TRUE)


```


subgroup analyses age

```{r}

# Step 0. Define age groups
mhdp <- mhdp %>%
  mutate(age_group = case_when(
    age <= 14 ~ "≤14",
    age <= 16 ~ "15–16",
    TRUE ~ "≥17"
  ))

# ────────────────────────────────────────────────
# WITHIN-GROUP META-ANALYSIS (Pre–Post Change)
# ────────────────────────────────────────────────

# Step 1. Function to compute within-group PHQ change by age group
compute_within_age <- function(data, label) {
  wide <- data %>%
    filter(timepoint %in% c(0, 4)) %>%
    select(participant_id, condition, age_group, timepoint, phq_total) %>%
    pivot_wider(
      names_from = timepoint,
      values_from = phq_total,
      names_prefix = "week_"
    ) %>%
    mutate(change = week_4 - week_0)

  summary_tbl <- wide %>%
    group_by(condition, age_group) %>%
    summarise(
      n = sum(!is.na(change)),
      mean_change = mean(change, na.rm = TRUE),
      sd_change = sd(change, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)
  
  return(summary_tbl)
}

# Step 2. Apply function to each dataset
datasetB_no_orando <- mhdp %>%
  filter(dataset == "Dataset B", school_name != "OrandoKisumu")

datasetA_all <- mhdp %>%
  filter(dataset == "Dataset A")

within_B_age <- compute_within_age(datasetB_no_orando, "Dataset B - without OrandoKisumu")
within_A_age <- compute_within_age(datasetA_all, "Dataset A - All Schools")

# Step 3. Combine and compute Hedges’ g
within_input_age <- bind_rows(within_B_age, within_A_age) %>%
  mutate(
    cohen_d = mean_change / sd_change,
    J = 1 - (3 / (4 * n - 9)),
    hedges_g = cohen_d * J,
    se_g = sqrt((1 / n) + (hedges_g^2 / (2 * n)))
  )

# Step 4. Run within-group meta-analysis by age group
meta_within_age <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", condition, "-", age_group),
  data = within_input_age,
  sm = "SMD",
  method.tau = "REML",
  random = TRUE,
  subgroup = age_group,
  title = "Within-Group (Pre–Post) PHQ Change by Age Group"
)

# View results
summary(meta_within_age)
forest(meta_within_age)

# ────────────────────────────────────────────────
# BETWEEN-GROUP META-ANALYSIS (Treatment vs Control)
# ────────────────────────────────────────────────

# Step 5. Prepare summary data for between-group analysis by age group
between_input_age <- mhdp %>%
  filter(timepoint == 4, condition %in% c("Shamiri", "TAU")) %>%  # 
  group_by(dataset, condition, age_group) %>%
  summarise(
    n = sum(!is.na(phq_total)),
    mean_phq = mean(phq_total, na.rm = TRUE),
    sd_phq = sd(phq_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  tidyr::pivot_wider(
    names_from = condition,
    values_from = c(n, mean_phq, sd_phq),
    names_sep = "."
  ) %>%
  mutate(
    # Pooled SD
    sd_pooled = sqrt(((n.Shamiri - 1) * sd_phq.Shamiri^2 +
                      (n.TAU - 1) * sd_phq.TAU^2) /
                      (n.Shamiri + n.TAU - 2)),

    # Cohen’s d (positive = Shamiri > TAU)
    cohen_d = (mean_phq.Shamiri - mean_phq.TAU) / sd_pooled,

    # Hedges’ correction
    J = 1 - (3 / (4 * (n.Shamiri + n.TAU) - 9)),
    hedges_g = cohen_d * J,

    # Standard error of g
    se_g = sqrt((n.Shamiri + n.TAU) / (n.Shamiri * n.TAU) +
                (hedges_g^2) / (2 * (n.Shamiri + n.TAU - 2))),

    study = dataset
  )

# Step 6. Run between-group meta-analysis by age group
meta_between_age <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", age_group),
  data = between_input_age,
  sm = "SMD",
  method.tau = "REML",
  random = TRUE,
  subgroup = age_group,
  title = "Between-Group (Shamiri vs TAU) PHQ Change by Age Group"
)

# View results
summary(meta_between_age)
forest(meta_between_age)


```





```{r}


# - Meta-analysis of the datasets (A, B, C)
# -  between-group
# - Using manually computed Hedges’ g and SE for meta-analysis

# Subset: Datasets for Between-Group (Treatment vs Control)
datasetB_two_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name == "OrandoKisumu")

datasetC_all_schools <- mhdp %>%
  filter(dataset == "Dataset C")

# TAU N
grp1n_db_tc_t <- datasetB_two_conditions %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(n = sum(!is.na(gad_total))) %>%
  pull(n)

grp1n_dc_t <- datasetC_all_schools %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(n = sum(!is.na(gad_total))) %>%
  pull(n)

# Shamiri N
grp1n_db_tc_s <- datasetB_two_conditions %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(n = sum(!is.na(gad_total))) %>%
  pull(n)

grp1n_dc_s <- datasetC_all_schools %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(n = sum(!is.na(gad_total))) %>%
  pull(n)

# TAU Mean
grp1m_db_tc_t <- datasetB_two_conditions %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(mean_gad = mean(gad_total, na.rm = TRUE)) %>%
  pull(mean_gad)

grp1m_dc_t <- datasetC_all_schools %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(mean_gad = mean(gad_total, na.rm = TRUE)) %>%
  pull(mean_gad)

# Shamiri Mean
grp1m_db_tc_s <- datasetB_two_conditions %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(mean_gad = mean(gad_total, na.rm = TRUE)) %>%
  pull(mean_gad)

grp1m_dc_s <- datasetC_all_schools %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(mean_gad = mean(gad_total, na.rm = TRUE)) %>%
  pull(mean_gad)

# TAU SD
grp1sd_db_tc_t <- datasetB_two_conditions %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(sd_gad = sd(gad_total, na.rm = TRUE)) %>%
  pull(sd_gad)

grp1sd_dc_t <- datasetC_all_schools %>%
  filter(condition == "TAU", timepoint == 4) %>%
  summarise(sd_gad = sd(gad_total, na.rm = TRUE)) %>%
  pull(sd_gad)

# Shamiri SD
grp1sd_db_tc_s <- datasetB_two_conditions %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(sd_gad = sd(gad_total, na.rm = TRUE)) %>%
  pull(sd_gad)

grp1sd_dc_s <- datasetC_all_schools %>%
  filter(condition == "Shamiri", timepoint == 4) %>%
  summarise(sd_gad = sd(gad_total, na.rm = TRUE)) %>%
  pull(sd_gad)

# Combine for meta-analysis
meta_input_gad <- data.frame(
  study = c("Dataset B with Both Conditions", "Dataset C"),
  n.e = c(grp1n_db_tc_s, grp1n_dc_s),
  mean.e = c(grp1m_db_tc_s, grp1m_dc_s),
  sd.e = c(grp1sd_db_tc_s, grp1sd_dc_s),
  n.c = c(grp1n_db_tc_t, grp1n_dc_t),
  mean.c = c(grp1m_db_tc_t, grp1m_dc_t),
  sd.c = c(grp1sd_db_tc_t, grp1sd_dc_t)
)

# Between-group meta-analysis (Shamiri vs TAU)
meta_d_gad <- metacont(
  n.e = n.e, mean.e = mean.e, sd.e = sd.e,
  n.c = n.c, mean.c = mean.c, sd.c = sd.c,
  studlab = study,
  data = meta_input_gad,
  sm = "SMD",
  method.smd = "Hedges",
  random = TRUE,
  method.tau = "REML",
  method.random.ci = "HK"
)

meta_d_gad


```



```{r}


# Prepare subsets
datasetB_one_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name != "OrandoKisumu")

datasetA_all_schools <- mhdp %>%
  filter(dataset == "Dataset A")

# Compute within-group GAD change
compute_within_gad <- function(data, label) {
  wide <- data %>%
    filter(timepoint %in% c(0, 4)) %>%
    select(participant_id, condition, timepoint, gad_total) %>%
    tidyr::pivot_wider(
      names_from = timepoint,
      values_from = gad_total,
      names_prefix = "week_"
    ) %>%
    mutate(change = week_4 - week_0)

  summary_tbl <- wide %>%
    group_by(condition) %>%
    summarise(
      n = sum(!is.na(change)),
      mean_change = mean(change, na.rm = TRUE),
      sd_change = sd(change, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)
  
  return(summary_tbl)
}

# Compute for Dataset B and A
within_B_gad <- compute_within_gad(datasetB_one_conditions, "Dataset B - without OrandoKisumu")
within_A_gad <- compute_within_gad(datasetA_all_schools, "Dataset A - All Schools")

# Combine
within_input_gad <- bind_rows(within_B_gad, within_A_gad)

# Compute Hedges' g for GAD
within_meta_gad <- within_input_gad %>%
  mutate(
    cohen_d = mean_change / sd_change,
    J = 1 - (3 / (4 * n - 9)),
    hedges_g = cohen_d * J,
    se_g = sqrt((1 / n) + (hedges_g^2 / (2 * n)))
  )

# Random-effects meta-analysis (within-group GAD)
meta_within_gad <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", condition),
  data = within_meta_gad,
  sm = "SMD",
  method.tau = "REML",
  hakn = TRUE,
  common = FALSE,
  random = TRUE,
  title = "Within-Group (Pre–Post) GAD Change"
)

# Results and forest plot
summary(meta_within_gad)
forest(meta_within_gad)




```





```{r}

# --- Within-group meta-analysis by gender (GAD) ---

# Step 1. Filter datasets
datasetB_one_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name != "OrandoKisumu")

datasetA_all_schools <- mhdp %>%
  filter(dataset == "Dataset A")

# Step 2. Function to compute within-group change by gender (GAD)
compute_within_gender_gad <- function(data, label) {
  wide <- data %>%
    filter(timepoint %in% c(0, 4)) %>%
    select(participant_id, condition, gender, timepoint, gad_total) %>%
    tidyr::pivot_wider(
      names_from = timepoint,
      values_from = gad_total,
      names_prefix = "week_"
    ) %>%
    mutate(change = week_4 - week_0)

  summary_tbl <- wide %>%
    group_by(condition, gender) %>%
    summarise(
      n = sum(!is.na(change)),
      mean_change = mean(change, na.rm = TRUE),
      sd_change = sd(change, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)

  return(summary_tbl)
}

# Step 3. Apply function to datasets
within_B_gender_gad <- compute_within_gender_gad(datasetB_one_conditions, "Dataset B - without OrandoKisumu")
within_A_gender_gad <- compute_within_gender_gad(datasetA_all_schools, "Dataset A - All Schools")

# Combine results
within_input_gender_gad <- bind_rows(within_B_gender_gad, within_A_gender_gad)

# Step 4. Compute effect sizes (Hedges' g and SE)
within_meta_gender_gad <- within_input_gender_gad %>%
  mutate(
    cohen_d = mean_change / sd_change,
    J = 1 - (3 / (4 * n - 9)),                     # Hedges’ correction
    hedges_g = cohen_d * J,
    se_g = sqrt((1 / n) + (hedges_g^2 / (2 * n)))  # Approximate SE
  ) %>%
  filter(!is.na(gender))   # remove missing genders

# Run meta-analysis with gender as subgroup
meta_within_gender_gad <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", condition, "-", gender),
  data = within_meta_gender_gad,
  sm = "SMD",
  method.tau = "REML",
  method.random.ci = "HK",
  common = FALSE,
  random = TRUE,
  subgroup = gender,
  print.subgroup.name = TRUE,
  title = "Within-Group (Pre–Post) GAD Change by Gender"
)

# Output results and forest plot
summary(meta_within_gender_gad)
forest(meta_within_gender_gad, layout = "RevMan5", print.subgroup.name = TRUE)


```




```{r}

### 2) Between-group meta-analysis by **gender** (GAD)
# --- BETWEEN-GROUP META-ANALYSIS BY GENDER (GAD) ---

# Filter datasets
datasetB_two_conditions <- mhdp %>%
  filter(dataset == "Dataset B", school_name == "OrandoKisumu")

datasetC_all_schools <- mhdp %>%
  filter(dataset == "Dataset C")

# Function to compute summary stats by condition and gender (GAD)
get_summary_gender_gad <- function(data, label) {
  data %>%
    filter(timepoint == 4) %>%
    group_by(condition, gender) %>%
    summarise(
      n = sum(!is.na(gad_total)),
      mean_gad = mean(gad_total, na.rm = TRUE),
      sd_gad = sd(gad_total, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)
}

# Compute summaries by gender for each dataset
sum_B_gender_gad <- get_summary_gender_gad(datasetB_two_conditions, "Dataset B - OrandoKisumu")
sum_C_gender_gad <- get_summary_gender_gad(datasetC_all_schools, "Dataset C")

# Combine results
sum_gender_gad <- bind_rows(sum_B_gender_gad, sum_C_gender_gad)

# Prepare dataset in wide format (Shamiri vs TAU per gender)
meta_input_gender_gad <- sum_gender_gad %>%
  tidyr::pivot_wider(
    names_from = condition,
    values_from = c(n, mean_gad, sd_gad),
    names_sep = "."
  ) %>%
  rename(
    n.e = n.Shamiri,
    mean.e = mean_gad.Shamiri,
    sd.e = sd_gad.Shamiri,
    n.c = n.TAU,
    mean.c = mean_gad.TAU,
    sd.c = sd_gad.TAU
  ) %>%
  mutate(
    # remove rows where one condition is missing (can't compute)
    eligible = !is.na(n.e) & !is.na(n.c) & n.e > 1 & n.c > 1
  ) %>%
  filter(eligible, !is.na(gender)) %>%
  mutate(
    # Pooled SD
    sd_pooled = sqrt(((n.e - 1) * sd.e^2 + (n.c - 1) * sd.c^2) / (n.e + n.c - 2)),
    # Cohen’s d
    cohen_d = (mean.e - mean.c) / sd_pooled,
    # Hedges’ correction
    J = 1 - (3 / (4 * (n.e + n.c) - 9)),
    hedges_g = cohen_d * J,
    # Standard error for Hedges’ g
    se_g = sqrt((n.e + n.c) / (n.e * n.c) + (hedges_g^2 / (2 * (n.e + n.c - 2))))
  )

# --- META-ANALYSIS with gender as subgroup ---
meta_gender_between_gad <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", gender),
  data = meta_input_gender_gad,
  sm = "SMD",
  method.tau = "REML",
  method.random.ci = "HK",
  common = FALSE,
  random = TRUE,
  subgroup = gender,
  print.subgroup.name = TRUE,
  title = "Between-Group (Shamiri vs TAU) GAD Effect Sizes by Gender"
)

# --- Output results ---
summary(meta_gender_between_gad)
forest(meta_gender_between_gad, layout = "RevMan5", print.subgroup.name = TRUE)


```




```{r}

### 3) Within-group meta-analysis by **age group** (GAD)
# --- WITHIN-GROUP META-ANALYSIS BY AGE GROUP (GAD) ---

# Define age groups (if not already defined)
mhdp <- mhdp %>%
  mutate(age_group = case_when(
    age <= 14 ~ "≤14",
    age <= 16 ~ "15–16",
    TRUE ~ "≥17"
  ))

# Function to compute within-group GAD change by age group
compute_within_age_gad <- function(data, label) {
  wide <- data %>%
    filter(timepoint %in% c(0, 4)) %>%
    select(participant_id, condition, age_group, timepoint, gad_total) %>%
    tidyr::pivot_wider(
      names_from = timepoint,
      values_from = gad_total,
      names_prefix = "week_"
    ) %>%
    mutate(change = week_4 - week_0)

  summary_tbl <- wide %>%
    group_by(condition, age_group) %>%
    summarise(
      n = sum(!is.na(change)),
      mean_change = mean(change, na.rm = TRUE),
      sd_change = sd(change, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(study = label)

  return(summary_tbl)
}

# Apply to datasets
datasetB_no_orando <- mhdp %>% filter(dataset == "Dataset B", school_name != "OrandoKisumu")
datasetA_all <- mhdp %>% filter(dataset == "Dataset A")

within_B_age_gad <- compute_within_age_gad(datasetB_no_orando, "Dataset B - without OrandoKisumu")
within_A_age_gad <- compute_within_age_gad(datasetA_all, "Dataset A - All Schools")

# Combine and compute effect sizes
within_input_age_gad <- bind_rows(within_B_age_gad, within_A_age_gad) %>%
  mutate(
    cohen_d = mean_change / sd_change,
    J = 1 - (3 / (4 * n - 9)),
    hedges_g = cohen_d * J,
    se_g = sqrt((1 / n) + (hedges_g^2 / (2 * n)))
  ) %>%
  filter(!is.na(age_group))

# Meta-analysis by age group
meta_within_age_gad <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", condition, "-", age_group),
  data = within_input_age_gad,
  sm = "SMD",
  method.tau = "REML",
  random = TRUE,
  subgroup = age_group,
  title = "Within-Group (Pre–Post) GAD Change by Age Group"
)

summary(meta_within_age_gad)
forest(meta_within_age_gad)


```




```{r}

### 4) Between-group meta-analysis by **age group** (GAD)
# --- BETWEEN-GROUP META-ANALYSIS BY AGE GROUP (GAD) ---

between_input_age_gad <- mhdp %>%
  filter(timepoint == 4, condition %in% c("Shamiri", "TAU")) %>%
  group_by(dataset, condition, age_group) %>%
  summarise(
    n = sum(!is.na(gad_total)),
    mean_gad = mean(gad_total, na.rm = TRUE),
    sd_gad = sd(gad_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  tidyr::pivot_wider(
    names_from = condition,
    values_from = c(n, mean_gad, sd_gad),
    names_sep = "."
  ) %>%
  mutate(
    # remove incomplete rows
    eligible = !is.na(n.Shamiri) & !is.na(n.TAU) & n.Shamiri > 1 & n.TAU > 1
  ) %>%
  filter(eligible & !is.na(age_group)) %>%
  mutate(
    sd_pooled = sqrt(((n.Shamiri - 1) * sd_gad.Shamiri^2 +
                      (n.TAU - 1) * sd_gad.TAU^2) /
                      (n.Shamiri + n.TAU - 2)),
    cohen_d = (mean_gad.Shamiri - mean_gad.TAU) / sd_pooled,
    J = 1 - (3 / (4 * (n.Shamiri + n.TAU) - 9)),
    hedges_g = cohen_d * J,
    se_g = sqrt((n.Shamiri + n.TAU) / (n.Shamiri * n.TAU) +
                (hedges_g^2) / (2 * (n.Shamiri + n.TAU - 2))),
    study = dataset
  )

meta_between_age_gad <- metagen(
  TE = hedges_g,
  seTE = se_g,
  studlab = paste(study, "-", age_group),
  data = between_input_age_gad,
  sm = "SMD",
  method.tau = "REML",
  random = TRUE,
  subgroup = age_group,
  title = "Between-Group (Shamiri vs TAU) GAD Change by Age Group"
)

summary(meta_between_age_gad)
forest(meta_between_age_gad)

```



```{r}


# Load packages
library(ggplot2)

# Data
data <- data.frame(
  Dataset = rep(c("Dataset A", "Dataset B"), each = 2),
  Period = factor(rep(c("Baseline → Week 4", "Week 4 → Week 8"), 2),
                  levels = c("Baseline → Week 4", "Week 4 → Week 8")),
  d = c(0.23, 0.08, 0.21, 0.19)
)

# Shamiri color palette
shamiri_colors <- c("#e63973", "#14213d")

# Plot
ggplot(data, aes(x = Dataset, y = d, fill = Period)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_fill_manual(values = shamiri_colors) +
  labs(
    title = "Depression Effect Sizes (Within Group)",
    y = "Cohen's d",
    x = NULL
  ) +
  theme_minimal(base_size = 14) +
  theme(
    text = element_text(color = "#14213d"),
    plot.title = element_text(face = "bold", color = "#14213d"),
    legend.title = element_blank(),
    legend.position = "top",
    panel.grid.major.y = element_line(linetype = "dashed", color = "grey80")
  )


```




```{r}


# Data
data <- data.frame(
  Dataset = rep(c("Dataset A", "Dataset B"), each = 2),
  Period = factor(rep(c("Baseline → Week 4", "Week 4 → Week 8"), 2),
                  levels = c("Baseline → Week 4", "Week 4 → Week 8")),
  d = c(0.23, 0.19, 0.34, 0.26)
)

# Shamiri color palette
shamiri_colors <- c("#e63973", "#14213d")

# Plot
ggplot(data, aes(x = Dataset, y = d, fill = Period)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_fill_manual(values = shamiri_colors) +
  labs(
    title = "Anxiety Effect Sizes (Within Group)",
    y = "Cohen's d",
    x = NULL
  ) +
  theme_minimal(base_size = 14) +
  theme(
    text = element_text(color = "#14213d"),
    plot.title = element_text(face = "bold", color = "#14213d"),
    legend.title = element_blank(),
    legend.position = "top",
    panel.grid.major.y = element_line(linetype = "dashed", color = "grey80")
  )



```



 Mixed-Effects Model

```{r}
library(lme4)
library(lmerTest) # Adds p-values to lme4

# Ensure timepoint is numeric for a linear growth model
mhdp_clean <- mhdp %>%
  mutate(timepoint_num = as.numeric(timepoint))

# Model: Effect of time, condition, and their interaction
# Random effects: (1 | school_name/participant_id) accounts for students nested in schools
lmm_phq <- lmer(phq_total ~ timepoint_num * condition + (1 | school_name/participant_id), 
                data = mhdp_clean)

summary(lmm_phq)

# Interpretation: If the interaction (timepoint_num:conditionShamiri) is negative and significant, 
# Shamiri students improved faster than TAU students over time.
```


Reliable exchange index

```{r}
# Step 1: Calculate Cronbach's Alpha for your population (Needed for RCI)
library(psych)
phq_items <- mhdp %>% select(phq_1:phq_8) %>% mutate(across(everything(), as.numeric))
alpha_res <- psych::alpha(phq_items, check.keys=TRUE)
rel <- alpha_res$total$raw_alpha # Internal consistency

# Step 2: RCI Calculation Logic
# We need Baseline (T0) and Endline (T4)
rci_df <- mhdp %>%
  filter(timepoint %in% c(0, 4)) %>%
  select(participant_id, condition, timepoint, phq_total) %>%
  pivot_wider(names_from = timepoint, values_from = phq_total, names_prefix = "T") %>%
  filter(!is.na(T0), !is.na(T4)) # Keep only completers

# Standard Error of Difference (Formula)
sd_baseline <- sd(rci_df$T0, na.rm = TRUE)
se_meas <- sd_baseline * sqrt(1 - rel)
se_diff <- sqrt(2 * (se_meas^2))

rci_df <- rci_df %>%
  mutate(
    diff = T4 - T0,
    rci_score = diff / se_diff,
    clinical_change = case_when(
      rci_score <= -1.96 ~ "Reliably Improved",
      rci_score >= 1.96 ~ "Reliably Deteriorated",
      TRUE ~ "No Reliable Change"
    )
  )

# View results by condition
table(rci_df$condition, rci_df$clinical_change)
```

```{r}

# Create a 'dropped_out' flag
attrition_df <- mhdp %>%
  group_by(participant_id) %>%
  summarise(
    baseline_phq = phq_total[timepoint == 0][1],
    dropped_out = !any(timepoint == 4),
    gender = gender[1]
  ) %>%
  filter(!is.na(baseline_phq))

# Logistic regression: Does baseline score predict dropout?
attrition_model <- glm(dropped_out ~ baseline_phq + gender, 
                       data = attrition_df, family = binomial)

summary(attrition_model)
# If baseline_phq p < 0.05,  study has attrition bias (more depressed kids dropped out).

```



```{r}

# Create the piecewise variables
mhdp_piecewise <- mhdp_clean %>%
  mutate(
    time_active = ifelse(timepoint_num <= 4, timepoint_num, 4),
    time_followup = ifelse(timepoint_num > 4, timepoint_num - 4, 0)
  )

# Model both slopes
lmm_piecewise <- lmer(phq_total ~ (time_active + time_followup) * condition + 
                      (1 | school_name/participant_id), 
                      data = mhdp_piecewise)

summary(lmm_piecewise)

```








```{r}

library(ggeffects)

# Predict values from the piecewise model
pred_piecewise <- ggpredict(lmm_piecewise, terms = c("time_active", "condition"))

# Plot
ggplot(pred_piecewise, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.1, color = NA) +
  labs(
    title = "Predicted PHQ-8 Trajectory (Active Phase Focus)",
    x = "Weeks (Active Phase)",
    y = "Predicted PHQ Score",
    color = "Group"
  ) +
  theme_minimal()

```



```{r}

# Filter for only those who were 'Clinical' (PHQ >= 10) at Baseline
mhdp_clinical_only <- mhdp_piecewise %>%
  group_by(participant_id) %>%
  filter(any(timepoint_num == 0 & phq_total >= 10)) %>%
  ungroup()

# Run the Piecewise model on this sub-group
lmm_clinical <- lmer(phq_total ~ (time_active + time_followup) * condition + 
                     (1 | school_name/participant_id), 
                     data = mhdp_clinical_only)

summary(lmm_clinical)


```



```{r}
library(ggeffects)

# 1. Get predicted values from the clinical model
pred_clin <- ggpredict(lmm_clinical, terms = c("time_active", "condition"))

# 2. Plotting the divergence
ggplot(pred_clin, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.15, color = NA) +
  scale_color_manual(values = c("Shamiri" = "#e63973", "TAU" = "#14213d")) +
  scale_fill_manual(values = c("Shamiri" = "#e63973", "TAU" = "#14213d")) +
  labs(
    title = "Clinical Sample: Divergence in Recovery (Weeks 0-4)",
    subtitle = "Shamiri leads to significantly faster symptom reduction (p = 0.023)",
    x = "Weeks of Active Intervention",
    y = "Predicted PHQ-8 Score",
    color = "Condition",
    fill = "Condition"
  ) +
  theme_minimal(base_size = 14)
```


```{r}


# Filter for only those who were 'Clinical' (PHQ >= 10) at Baseline
mhdp_clinical_only <- mhdp_piecewise %>%
  group_by(participant_id) %>%
  filter(any(timepoint_num == 0 & gad_total >= 10)) %>%
  ungroup()

# Run the Piecewise model on this sub-group
lmm_clinical <- lmer(gad_total ~ (time_active + time_followup) * condition + 
                     (1 | school_name/participant_id), 
                     data = mhdp_clinical_only)

summary(lmm_clinical)
```





